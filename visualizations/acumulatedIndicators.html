<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>FICA - Por Acumulação de Indicadores</title>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
          crossorigin="anonymous">
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/bootstrap-datepicker1-4-1.min.css" rel="stylesheet">
    <link href="../css/visualizations.css" rel="stylesheet">
</head>

<body>
<div class="fixed-top p-2" align="right" style="z-index: 0;">
    <button class="btn btn-sm btn-info" onclick="$('#help').modal('show');">
        <i class="fas fa-info-circle mr-2"></i> Ajuda
    </button>
</div>
<div class="container">
    <div class="row mt-2 table-secondary rounded p-2" style="z-index: 1;">
        <div class="col-12 col-md-6 col-lg-3" align="center">
            <a href="../index.html" class="btn btn-sm btn-light full_w">
                <i class="fas fa-home mr-2"></i> Menu
            </a>
        </div>
        <div class="col-12 col-md-6 col-lg-3" align="center">
            <a href="indicators.html" class="btn btn-sm btn-light full_w">
                <i class="fas fa-chart-bar mr-2"></i> Indicador
            </a>
        </div>
        <div class="col-12 col-md-6 col-lg-3" align="center">
            <a href="acumulatedIndicators.html" class="btn btn-sm btn-light full_w active">
                <i class="fas fa-chart-area mr-2"></i> Acumulação de Indicadores
            </a>
        </div>
        <div class="col-12 col-md-6 col-lg-3" align="center">
            <a href="" class="btn btn-sm btn-light full_w">
                <i class="fas fa-chart-line mr-2"></i> Evolução de Indicadores
            </a>
        </div>
    </div>
    <div class="row mt-2 table-secondary rounded">
        <form class="form-inline full_w p-2">
            <div class="form-group col-12 col-lg-3 pl-3">
                <label for="type">Tipo:</label>
                <select id="type" class="form-control ml-2">
                </select>
            </div>

            <div class="form-group col-12 col-md-8 col-lg-6 pl-3">
                <label for="start">Mês:</label>
                <input type="text" id="start" class="date-picker form-control ml-2 mr-2">

                <label for="end">Até:</label>
                <div class="input-group">
                    <div class="input-group-prepend ml-2">
                        <div class="input-group-text">
                            <input type="checkbox" id="range_toggle" title="Ative para definir um período de pesquisa.">
                        </div>
                    </div>
                    <input type="text" id="end" class="date-picker form-control" style="display: none;">
                </div>

            </div>

            <div class="form-group col-12 col-lg-3 pl-3" style="display: none;">
                <label for="courses">Curso:</label>
                <select id="courses" class="form-control ml-2" style="display: none;">
                </select>
            </div>
        </form>
    </div>
    <div class="row mt-2">
        <div class="col-12" align="center" id="loading">
            <div class="spinner-border" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <div class="col-12" align="center" id="error">
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-12 col-lg-6">
            <div id="chart"></div>
        </div>
        <div class="col-12 col-lg-6">
            <div id="aux_chart"></div>
        </div>
        <div class="col-12">
            <div class="table-responsive">
                <table id="studentsTable" class="d3-table table table-fixed table-responsive table-striped table-hover"></table>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="help">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Indicadores</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="accordion">
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript" src="../js/d3.min.js"></script>
<script type="text/javascript" src="../js/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../js/bootstrap.min.js"></script>
<script type="text/javascript" src="../js/bootstrap-datepicker-1-4-1.min.js"></script>
<script type="text/javascript" src="../js/main.js"></script>

<script type="text/javascript">
    const margin = 80;
    const width = window.innerWidth / 2 - 2 * margin;
    const height = window.innerHeight / 2 - 2 * margin;

    function checkLocalStorage(){
        for (var i = 0; i < localStorage.length; i++){
            $('#'+localStorage.key(i)+'[type!=\'checkbox\']').val(localStorage[localStorage.key(i)]);
            $('#'+localStorage.key(i)+'[type=\'checkbox\']').each(function () {
                if(''+$(this).prop("checked") !== localStorage[localStorage.key(i)]){
                    $(this).prop("checked", localStorage[localStorage.key(i)]).trigger('change');
                }
            });
        }
    }

    function update_graphs() {
        $('#chart').html('');
        $('#aux_chart').html('');
        $('#studentsTable').html('');

        $('#loading').show();
        $('#error').hide();

        let files = null;
        if ($('#range_toggle:checked').length > 0) {
            files = getFileNames($('#type').val(), $('#start').val(), $('#end').val());
        } else {
            files = getFileNames($('#type').val(), $('#start').val(), $('#start').val());
        }

        let loader = d3
            .queue()
            .defer(d3.csv, "../config/indicators.csv");

        for (var f = 0; f < files.length; f++) {
            if ($('#type').find(":selected").length > 0 && $('#type').find(":selected").data("courses").length > 0) {
                loader.defer(d3.csv, "../data/" + files[f] + "_" + $("#courses").val() + ".csv");
            } else {
                loader.defer(d3.csv, "../data/" + files[f] + ".csv");
            }
        }

        loader
            .awaitAll(function (error, dataSet) {
                $('#loading').hide();
                if (error) {
                    error = error.currentTarget.responseURL.split('/');
                    let file = error.pop();
                    $('#error').html('<h5 style="color: #a71d2a;" class="mt-3">Filtro inválido: ' + error.pop() + '/' + file + ' não existe!</h5>').show();
                    return;
                }
                $('#error').hide();

                // parse values to integers
                let indicators = dataSet.shift();
                indicators.forEach(function (ind) { ind['value'] = +ind['value']; });

                // process data
                var acumulatedIndicatorsCounter = new Array(indicators.length + 1).fill(0);

                var indicatorStudents = new Array(indicators.length + 1);
                for (var i = 0; i < indicatorStudents.length; i++) {
                    indicatorStudents[i] = [];
                }

                var numEntries = 0;
                dataSet.forEach(function (data) {
                    data.forEach(function (entry) {
                        var acumulated = 0;
                        var i;
                        for (i = 0; i < indicators.length; i++) {
                            if (+entry[indicators[i]['column']] >= indicators[i]['value']) {
                                acumulated++;
                            }
                        }

                        acumulatedIndicatorsCounter[acumulated]++;
                        indicatorStudents[acumulated].push(entry);
                        numEntries++;
                    });
                });

                var numberOfAcumulatedIndicators = ["0", "1", "2", "3", "4", "5"];
                createBarChart('#chart',
                    numberOfAcumulatedIndicators, acumulatedIndicatorsCounter, numEntries, indicatorStudents,
                    "Nº de indicadores acumulados", "Nº de alunos", "Por Acumulação de Indicadores");
            });
    }

    $(document).ready(function () {
        $('input[type!=\'checkbox\'], select').on("change", function () {
            localStorage[$(this).attr('id')] = $(this).val();
        });

        $('input[type=\'checkbox\']').on("focusout", function () {
            localStorage[$(this).attr('id')] = $(this).prop('checked');
        });

        d3.csv("../config/courses.csv", function (error, data) {
            if (error) return;
            $('#type').find('option').remove();
            data.forEach(function (entry) {
                $("#type").append($("<option></option>").text(entry.name)
                    .attr("value", entry.path).attr("data-courses", entry.values));
            });
            checkLocalStorage();
            update_graphs();
        });

        $('#range_toggle').on("change", function () {
            if ($(this).prop('checked') !== $("#end").is(":visible")) {
                $("#end").animate({ width: "toggle" });
                update_graphs();
            }
        });

        $('#type').on("change", function () {
            let courses = $("#courses");
            if ($(this).find(':selected').length > 0 && $(this).find(':selected').data('courses').length > 0) {
                courses.find('option').remove();
                $(this).find(':selected').data('courses').split(',').forEach(function (entry) {
                    $("#courses").append($("<option></option>").text(entry).attr("value", entry));
                });
                if ($("#courses:visible").length === 0) {
                    courses.parent().show();
                    courses.animate({ width: "toggle" });
                }
            } else {
                if ($("#courses:visible").length > 0) {
                    courses.animate({ width: "toggle" }, 500, function () {
                        courses.parent().hide();
                    });
                }
            }
            update_graphs();
        });

        $('#courses').on("change", function () {
            update_graphs();
        });

        $.fn.datepicker.dates['pt'] = {
            days: ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"],
            daysShort: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"],
            daysMin: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"],
            months: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"],
            monthsShort: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"],
            today: "Hoje",
            weekStart: 1,
        };

        let current = new Date();
        let date_pickers = $('.date-picker');
        date_pickers.val(current.getFullYear() + '-' + lpad(current.getMonth() + 1, 0, 2));

        checkLocalStorage();

        date_pickers.datepicker({
            format: 'yyyy-mm', autoclose: true, orientation: "top",
            language: "pt", startView: "years", minViewMode: "months"
        }).on("changeDate", function (e) {
            update_graphs();
        });

        d3.csv("../config/indicators.csv", function (error, data) {
            if (!error) {
                data.forEach(function (entry) {
                    $("#accordion").append(' \
                            <div class="card">  \
                                <div class="card-header" id="heading_' + entry.name + '"> \
                                    <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapse_' + entry.name + '" aria-expanded="false" aria-controls="collapseThree"> <i class="fas fa-hand-pointer mr-2"></i>' + entry.name + ' </button>   \
                                </div>  \
                                <div id="collapse_' + entry.name + '" class="collapse" aria-labelledby="heading_' + entry.name + '" data-parent="#accordion">   \
                                    <div class="card-body"> ' + entry.description + ' </div>    \
                                </div>  \
                            </div>' );

                });
            }
        });
    });
</script>
</body>

</html>