<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>FICA - Por Indicador</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/bootstrap-datepicker1-4-1.min.css" rel="stylesheet">
    <link href="../css/visualizations.css" rel="stylesheet">
</head>

<body>

    <div class="container">
        <div class="row mt-2 table-secondary rounded">
            <form class="form-inline full_w p-2">
                <div class="form-group col-lg-3 pl-3">
                    <label for="type">Tipo:</label>
                    <select id="type" class="form-control ml-2">
                    </select>
                </div>

                <div class="form-group col-md-8 col-lg-6 pl-3">
                    <label for="start">Mês:</label>
                    <input type="text" id="start" class="date-picker form-control ml-2 mr-2">

                    <label for="end">Até:</label>
                    <div class="input-group">
                        <div class="input-group-prepend ml-2">
                            <div class="input-group-text">
                                <input type="checkbox" id="range_toggle" title="Ative para definir um período de pesquisa.">
                            </div>
                        </div>
                        <input type="text" id="end" class="date-picker form-control" style="display: none;">
                    </div>

                </div>

                <div class="form-group col-lg-3 pl-3" style="display: none;">
                    <label for="courses">Curso:</label>
                    <select id="courses" class="form-control ml-2" style="display: none;">
                    </select>
                </div>
            </form>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div id="chart"></div>
            </div>
            <div class="col-lg-6">
                <div id="aux_chart"></div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="table-responsive">
                <table id="studentsTable" class="table table-fixed table-striped table-hover"></table>
            </div>
        </div>
    </div>


    <script type="text/javascript" src="../js/d3.min.js"></script>
    <script type="text/javascript" src="../js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="../js/bootstrap-datepicker-1-4-1.min.js"></script>
    <script type="text/javascript" src="../js/main.js"></script>

    <script type="text/javascript">
        const margin = 80;
        const width = window.innerWidth / 2 - 2 * margin;
        const height = window.innerHeight / 2 - 2 * margin;

        function update_graphs() {
            $('#chart').html('');
            $('#aux_chart').html('');
            $('#studentsTable').html('');

            let files = null;
            if ($('#range_toggle:checked').length > 0) {
                files = getFileNames($('#type').val(), $('#start').val(), $('#end').val());
            } else {
                files = getFileNames($('#type').val(), $('#start').val(), $('#start').val());
            }

            let loader = d3
                .queue()
                .defer(d3.csv, "../config/indicators.csv");

            for (var f = 0; f < files.length; f++) {
                if ($('#type').find(":selected").data("courses").length > 0) {
                    loader.defer(d3.csv, "../data/" + files[f] + "_" + $("#courses").val() + ".csv");
                } else {
                    loader.defer(d3.csv, "../data/" + files[f] + ".csv");
                }
            }

            loader
                .awaitAll(function (error, dataSet) {
                    if (error) {
                        error = error.currentTarget.responseURL.split('/');
                        let file = error.pop();
                        $('#chart').html('<h3 class="mt-3">Filtro inválido: ' + error.pop() + '/' + file + ' não existe!</h3>');
                        return;
                    }

                    // parse values to integers
                    let indicators = dataSet.shift();
                    indicators.forEach(function (ind) { ind['value'] = +ind['value']; });

                    // process data
                    var indicatorCounter = new Array(indicators.length).fill(0);
                    var indicatorStudents = new Array(indicators.length);
                    for (var i = 0; i < indicatorStudents.length; i++)
                        indicatorStudents[i] = [];
                    var numEntries = 0;

                    dataSet.forEach(function (data) {
                        data.forEach(function (entry) {
                            var i;
                            for (i = 0; i < indicators.length; i++) {
                                if (+entry[indicators[i]['column']] >= indicators[i]['value']) {
                                    indicatorCounter[i]++;
                                    indicatorStudents[i].push(entry);
                                }
                            }
                            numEntries++;
                        });
                    });

                    var indicatorsNames = indicators.map(function (item) { return item['name']; });
                    createBarChart('#chart',
                        indicatorsNames, indicatorCounter, numEntries, indicatorStudents,
                        "Indicadores", "Nº de alunos", "Por Indicador");
                });
        }

        $(document).ready(function () {
            d3.csv("../config/courses.csv", function (error, data) {
                if (error) return;
                $('#type').find('option').remove();
                data.forEach(function (entry) {
                    $("#type").append($("<option></option>").text(entry.name)
                        .attr("value", entry.path).attr("data-courses", entry.values));
                });
                update_graphs();
            });

            $('#range_toggle').on("change", function () {
                $("#end").animate({ width: "toggle" });
                update_graphs();
            });

            $('#type').on("change", function () {
                let courses = $("#courses");
                if ($(this).find(':selected').length > 0 && $(this).find(':selected').data('courses').length > 0) {
                    if ($("#courses:visible").length === 0) {
                        courses.find('option').remove();
                        $(this).find(':selected').data('courses').split(',').forEach(function (entry) {
                            $("#courses").append($("<option></option>").text(entry).attr("value", entry));
                        });
                        courses.parent().show();
                        courses.animate({ width: "toggle" });
                    }
                } else {
                    if ($("#courses:visible").length > 0) {
                        courses.animate({ width: "toggle" }, 500, function () {
                            courses.parent().hide();
                        });
                    }
                }
                update_graphs();
            });

            $('#courses').on("change", function () {
                update_graphs();
            });

            $.fn.datepicker.dates['pt'] = {
                days: ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"],
                daysShort: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"],
                daysMin: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"],
                months: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"],
                monthsShort: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"],
                today: "Hoje",
                weekStart: 1,
            };

            let current = new Date();
            let date_pickers = $('.date-picker');
            date_pickers.val(current.getFullYear() + '-' + lpad(current.getMonth() + 1, 0, 2));

            date_pickers.datepicker({
                format: 'yyyy-mm', autoclose: true, orientation: "top",
                language: "pt", startView: "years", minViewMode: "months"
            }).on("changeDate", function (e) {
                update_graphs();
            });
        });
    </script>
</body>

</html>